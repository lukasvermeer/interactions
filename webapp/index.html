<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Experiment Interactions Checker</title>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">

    <script type="text/javascript" src="vue/vue.min.js"></script>
    <script type="text/javascript" src="lib/statistics-distributions.js"></script>

    </head>
    <body>
      <div class="content-wrapper" id="app-tester">
        <div class="container">
          <div class="row">
            <div class="col-md-offset-3 col-md-6">
              <div class="lead">
                <h2>Experiment Interactions Checker</h2>
              </div>

              <p>TODO: write intro</p>

              <form>
                <div v-for="(item, index) in input.table">
                  <div v-for="(cell, cindex) in item">
                    <div class="form-group col-xs-5">
                      <label for="obs-{{ index }}{{ cindex }}">Conversions in {{ String.fromCharCode(65 + index) }}+{{ String.fromCharCode(65 + cindex) }}</label>
                      <input v-model="item[cindex]" type="number" pattern="\d*" min="0" class="form-control" id="obs-{{ index }}{{ cindex }}" placeholder="Observed sample size"/> 
                    </div>
                  </div>
                </div>
              </form>
              <br />
            </div>
            <div class="col-md-offset-3 col-md-6">

              <div class="alert alert-warning" v-if="flag_interact">
                <em>Warning.</em> Possible interaction detected with <var>{{ display_p }}</var>.
                The observed sample sizes in each group does not match the expected proportion of the total sample size.
                <strong>Comparative statistics may be invalid as a result.</strong>
              </div>

              <div class="alert alert-success text-center" v-if="!flag_interact">
                No indication of interactions with <var>{{ display_p }}</var>.
              </div>

              <footer class="text-center">
                <small>Designed with <i class="glyphicon glyphicon-heart"></i> by <a href="www.lukasvermeer.nl" target="_blank">Lukas Vermeer</a> for experimenters everywhere</small>
              </footer>
            </div>
          </div>
        </div>
      </div>

      <script type="text/javascript">
      tester = new Vue({
        el: '#app-tester',
        data: {
          input: {
            table: [["",""], ["",""]],
          },
        },
        methods: {
          // Checking for interactions using chi-square
          chisquare: function(observed, expected) {
            // Check if input contains only numbers, and two matrices of equal dimensions
            if (observed.some((x) => (x.some((y) => !Number.isFinite(y))))) { return NaN; }
            if (expected.some((x) => (x.some((y) => !Number.isFinite(y))))) { return NaN; }
            if (expected.length !== observed.length) { return NaN; }
            if (expected.some((x,i) => x.length !== observed[i].length)) { return NaN; }

            // Degrees of freedom is variations - 1
            const df = observed.length - 1;

            // Chi-square is sum of squares of observed - expected over expected for each cell
            const chisq = expected.reduce((a, e, i) => a + e.reduce((b, f, j) => (b + ((observed[i][j] - f) ** 2) / f), 0), 0);

            return chisqrprob(df, chisq);
          },
        },
        computed: {
          expected_under_null: function() {
            let row_sums = this.table_int.map((v) => v.reduce((a, e) => a + e, 0));
            let col_sums = this.table_int.reduce((a, e) => e.map((v, i) => (a[i]||0) + v), []);

            let row_means = row_sums.map(v => v / this.table_int[0].length);
            let col_means = col_sums.map(v => v / this.table_int.length);
            let grand_mean = row_means.reduce((a,v) => a + v, 0) / row_means.length;

            // Expected for each cell is mean_row * mean_col / grand_mean
            let expected = row_means.map((r) => col_means.map((c) => r * c / grand_mean));

            return expected;
          },
          table_int: function() {
            return this.input.table.map((v) => (v.map((w) => parseInt(w))));
          },
          interact_p: function(v) {
            let p = this.chisquare(this.table_int, this.expected_under_null);
            return p;
          },
          flag_interact: function() {
            return this.interact_p < 0.05;
          },
          display_p: function() {
            const precision = 4;
            const smallest_display = 1/(10**precision);
            if (this.interact_p < smallest_display) {
              return "p < " + smallest_display;
            } else {
              return "p = " + this.interact_p.toFixed(4);
            }
          }
        }
      });
    </script>
    </body>
</html>
